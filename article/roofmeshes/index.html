
<!doctype html>
<html class="no-js" lang="en">
    <head>
        <title>
            Generating 3D roof meshes from aerial LIDAR data | Marian's Blog
		</title>

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="author" content="Marian Kleineberg">
        <meta name="description" content="Generating 3D roof meshes from aerial LIDAR data - Personal blog about game development, programming and making">
        <meta itemprop="name" content="Generating 3D roof meshes from aerial LIDAR data">
        <meta itemprop="description" content="Generating 3D roof meshes from aerial LIDAR data - Personal blog about game development, programming and making">
        <meta property="og:title" content="Generating 3D roof meshes from aerial LIDAR data">
        <meta property="og:description" content="Generating 3D roof meshes from aerial LIDAR data - Personal blog about game development, programming and making">
        <meta property="og:image" content="https://marian42.de/article/roofmeshes/example_1280.png">
        <meta property="og:url" content="https://marian42.de/article/roofmeshes/">
        <meta property="og:site_name" content="Marian's Blog"><meta property="og:type" content="website">

        <link rel="icon" type="image/png" href="https://marian42.de/favicon-32x32.png" sizes="32x32">
        <link rel="icon" type="image/png" href="https://marian42.de/favicon-16x16.png" sizes="16x16">

        <link href="https://marian42.de/index.xml" rel="feed" type="application/rss+xml" title="Marian's Blog" />
                
        <link rel="stylesheet" href="/style.css">        
    </head>
    <body>
        <header class="triangle-pattern">
            <div class="container">
                <a href="/" class="logo" alt="Marian's Blog">
                </a>
            </div>
        </header>
        
        <article class="card">
    <a href="/article/roofmeshes/">
        <h1>Generating 3D roof meshes from aerial LIDAR data</h1>
    </a>
    <div class="timestamp">January  2, 2018</div>
    <div class="content">
        <p><figure>
    <a href="example.png">
        <img src="example_1280.png" alt="">
    </a>
</figure></p>
<p>This is my graduation project I did in computer science. The goal was to come up with a method to generate 3D meshes of building roofs from point cloud data. The point cloud data was taken with aerial <a href="https://en.wikipedia.org/wiki/Lidar">LIDAR</a> scanners and is <a href="https://www.opengeodata.nrw.de/produkte/geobasis/dom/dom1l/">available online</a>. In addition, I used building layout polygons, which are also available as open data. I tested several strategies to generate a mesh and I’ll explain the best one in this post.</p>
<h2>Separating the point cloud by buildings</h2>
<p>The dataset for the city of Dortmund contains about 4×10^9 points. For this city, the building layout dataset has about 200,000 entries. My first step was to write a program that finds the subset of points that belong to each building.</p>
<p>As the building layouts are polygons, the core of this operation is the <a href="https://en.wikipedia.org/wiki/Point_in_polygon">point in polygon test</a>. The important takeaway for this part is to use spatial hashing. The polygons are stored in a hash set so that for each point, only a few polygons need to be considered. It took four hours to process 100 GB of data on my laptop.</p>
<p><figure>
    <a href="separation.png">
        <img src="separation.png" alt="">
    </a>
</figure></p>
<h2>Finding planes</h2>
<p>The next step is to look for planes that describe many of the points in a point cloud. These planes are likely to portray roof faces, which makes them a good foundation for generating a roof mesh.</p>
<p>It turned out that a <a href="https://en.wikipedia.org/wiki/Random_sample_consensus">RANSAC</a> approach works well for this problem. The idea of RANSAC is to select a subset of points at random and generate planes from these sample points. To get a sample plane from a sample point, a fit plane for nearby points is calculated. For each sample plane, a score is calculated that tells how well the plane fits the entire point cloud. The best scoring planes are returned.</p>
<p>The picture below shows an example point cloud with planes found by the RANSAC algorithm.</p>
<p><figure>
    <a href="ransac.png">
        <img src="ransac.png" alt="">
    </a>
</figure></p>
<h2>Algorithm to generate convex roof meshes</h2>
<p>Now that we have a set of points that belong to a single building, the building’s layout polygon and a set of planes, it’s time for a mesh generation algorithm. The idea of this algorithm is to start with an infinetly extruded layout polygon and cut away each of the roof plane. Each cut creates a roof face.</p>
<p>Here are some examples of roof types that can be modeled this way:</p>
<p><figure>
    <a href="convex.png">
        <img src="convex_1280.png" alt="">
    </a>
</figure></p>
<p>The algorithm to generate these meshes works a bit different from the explanation above. For each roof face, the layout polygon is triangulated and projected onto the plane. In a second step, this mesh is cut along all roof planes, leaving only the geometry that lies below all other planes. All roof faces are generated like this and are then combined.</p>
<p>This graphic shows a run of this algorithm with a simple gabled roof. Two roof planes result in two roof faces. For each plane, there is only one other plane that is cut away from the mesh.</p>
<p><figure>
    <a href="algorithmexample.png">
        <img src="algorithmexample_1280.png" alt="">
    </a>
</figure></p>
<p>The choice of roof planes is quite important, as the RANSAC algorithm usually returns more than the desired set of planes. To find the best ones, each possible subset of planes is tested. Each time, a roof mesh is generated and scored. The best one is returned.</p>
<p>Here are some examples of meshes generated with the above algorithm:</p>
<table>
<thead>
<tr>
  <th></th>
  <th></th>
  <th></th>
  <th></th>
</tr>
</thead>
<tbody>
<tr>
  <td><figure>
    <a href="konvexa.png">
        <img src="konvexa.png" alt="">
    </a>
</figure></td>
  <td><figure>
    <a href="konvexb.png">
        <img src="konvexb.png" alt="">
    </a>
</figure></td>
  <td><figure>
    <a href="konvexc.png">
        <img src="konvexc.png" alt="">
    </a>
</figure></td>
  <td><figure>
    <a href="konvexd-1.png">
        <img src="konvexd-1.png" alt="">
    </a>
</figure></td>
</tr>
</tbody>
</table>
<h2>Attachments</h2>
<p>As the name suggests, the algorithm to generate convex roofs is limited to convex roofs. In the real world, many roofs aren’t convex, like these ones:</p>
<p><figure>
    <a href="attachments.png">
        <img src="attachments.png" alt="">
    </a>
</figure></p>
<p>To generete roof meshes for these roofs, I extended the algorithm to look for attachments. It starts with a convex roof. For each face, the subset of points above the roof plane is considered. The same algorithm is used to generate meshes for attachments. These attachments are added to the resulting mesh.</p>
<p>A postprocessing step is needed to avoid some unwanted geometry that arises from combining the base mesh with the attachment meshes. Sometimes, this step introduces unwanted artifacts in the result.</p>
<p>Here are some exmaples of convex roofs with attachments:</p>
<table>
<thead>
<tr>
  <th></th>
  <th></th>
  <th></th>
  <th></th>
</tr>
</thead>
<tbody>
<tr>
  <td><figure>
    <a href="anbaua.png">
        <img src="anbaua.png" alt="">
    </a>
</figure></td>
  <td><figure>
    <a href="anbaub.png">
        <img src="anbaub.png" alt="">
    </a>
</figure></td>
  <td><figure>
    <a href="anbauc.png">
        <img src="anbauc.png" alt="">
    </a>
</figure></td>
  <td><figure>
    <a href="anbaud.png">
        <img src="anbaud.png" alt="">
    </a>
</figure></td>
</tr>
</tbody>
</table>
<h2>Implementation</h2>
<p>I used the Unity game engine to test the algorithms. Unity makes it easy to display meshes and point clouds. For common geometry problems like triangulating polygons, there is code available online.</p>
<p><figure>
    <a href="gui-1.png">
        <img src="gui-1_1280.png" alt="">
    </a>
</figure></p>
<p><a href="https://github.com/marian42/pointcloud">You can find the source code for the Unity implementation on github.</a></p>
<h2>Data sources</h2>
<p>The point data used in the screenshots in this article was calculated using point data and shape data from https://www.opengeodata.nrw.de/
Source for point data: https://www.opengeodata.nrw.de/produkte/geobasis/dom/dom1l/dom1l_05913000_Dortmund_EPSG25832_XYZ.zip
Source for shape data: https://www.opengeodata.nrw.de/produkte/geobasis/lika/alkis_sek/hu_nw/hu_nw_EPSG4647_Shape.zip
The data was provided by the &quot;Land NRW&quot; under the Data licence Germany – attribution – Version 2.0 (dl-de/by-2-0) Full license text is available at http://www.govdata.de/dl-de/by-2-0
The screenshots in this article contain map data by <a href="https://openstreetmap.org/">OpenStreetMap</a> (ODbL) and Positron tiles by <a href="https://cartodb.com/attributions#basemaps">CartoDB</a> (<a href="https://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>).</p>

    </div>
</article>

        <footer>
            <div class="socials">
                <div class="inner-div">
                    <a href="mailto:mail@marian42.de">
                        Contact
                    </a>
                </div>
                <div>
                    <a href="https://mastodon.gamedev.place/@marian42" rel="me" title="Follow me on Mastodon" class="social-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="-32 0 512 512">                                
                            <path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/>
                        </svg>
                    </a>
                    <a href="https://twitter.com/marian42_" title="Follow me on Twitter" class="social-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 248 204">
                            <path d="M221.95,51.29c0.15,2.17,0.15,4.34,0.15,6.53c0,66.73-50.8,143.69-143.69,143.69v-0.04 C50.97,201.51,24.1,193.65,1,178.83c3.99,0.48,8,0.72,12.02,0.73c22.74,0.02,44.83-7.61,62.72-21.66 c-21.61-0.41-40.56-14.5-47.18-35.07c7.57,1.46,15.37,1.16,22.8-0.87C27.8,117.2,10.85,96.5,10.85,72.46c0-0.22,0-0.43,0-0.64 c7.02,3.91,14.88,6.08,22.92,6.32C11.58,63.31,4.74,33.79,18.14,10.71c25.64,31.55,63.47,50.73,104.08,52.76 c-4.07-17.54,1.49-35.92,14.61-48.25c20.34-19.12,52.33-18.14,71.45,2.19c11.31-2.23,22.15-6.38,32.07-12.26 c-3.77,11.69-11.66,21.62-22.2,27.93c10.01-1.18,19.79-3.86,29-7.95C240.37,35.29,231.83,44.14,221.95,51.29z"/>
                        </svg>
                    </a>
                    <a href="https://github.com/marian42" title="View my code on Github" class="social-icon">
                        <svg viewbox="0 0 98 96" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M48.854 0C21.839 0 0 22 0 49.217c0 21.756 13.993 40.172 33.405 46.69 2.427.49 3.316-1.059 3.316-2.362 0-1.141-.08-5.052-.08-9.127-13.59 2.934-16.42-5.867-16.42-5.867-2.184-5.704-5.42-7.17-5.42-7.17-4.448-3.015.324-3.015.324-3.015 4.934.326 7.523 5.052 7.523 5.052 4.367 7.496 11.404 5.378 14.235 4.074.404-3.178 1.699-5.378 3.074-6.6-10.839-1.141-22.243-5.378-22.243-24.283 0-5.378 1.94-9.778 5.014-13.2-.485-1.222-2.184-6.275.486-13.038 0 0 4.125-1.304 13.426 5.052a46.97 46.97 0 0 1 12.214-1.63c4.125 0 8.33.571 12.213 1.63 9.302-6.356 13.427-5.052 13.427-5.052 2.67 6.763.97 11.816.485 13.038 3.155 3.422 5.015 7.822 5.015 13.2 0 18.905-11.404 23.06-22.324 24.283 1.78 1.548 3.316 4.481 3.316 9.126 0 6.6-.08 11.897-.08 13.526 0 1.304.89 2.853 3.316 2.364 19.412-6.52 33.405-24.935 33.405-46.691C97.707 22 75.788 0 48.854 0z"/>
                        </svg>
                    </a>
                    <a href="/index.xml" title="RSS feed" class="social-icon">
                        <svg viewBox="0 0 8 8" xmlns="http://www.w3.org/2000/svg">
                            <path d="M 0.38705632,0.38705632 V 1.5913525 A 6.021594,6.021594 0 0 1 6.4086474,7.6129437 H 7.6129437 A 7.2259129,7.2259129 0 0 0 0.38705632,0.38705632 Z m 0,2.40864748 V 4 A 3.6129564,3.6129564 0 0 1 4,7.6129437 H 5.2042963 A 4.8172751,4.8172751 0 0 0 0.38705632,2.7957038 Z M 1.3430849,5.7008865 A 0.95602666,0.95602666 0 0 0 0.38705632,6.6569151 0.95602666,0.95602666 0 0 0 1.3430849,7.6129437 0.95602666,0.95602666 0 0 0 2.2991135,6.6569151 0.95602666,0.95602666 0 0 0 1.3430849,5.7008865 Z" />
                        </svg>
                    </a>
                </div>
            </div>
            <div class="decorator triangle-pattern">
            </div>
        </footer>
    </body>
</html>