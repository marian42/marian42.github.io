
<!doctype html>
<html class="no-js" lang="en">
    <head>
        <title>
            Visualizing 150000 butterflies from the Natural History Museum | Marian's Blog
		</title>

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="author" content="Marian Kleineberg">
        <meta name="description" content="Visualizing 150000 butterflies from the Natural History Museum - Personal blog about game development, programming and making">
        <meta itemprop="name" content="Visualizing 150000 butterflies from the Natural History Museum">
        <meta itemprop="description" content="Visualizing 150000 butterflies from the Natural History Museum - Personal blog about game development, programming and making">
        <meta property="og:title" content="Visualizing 150000 butterflies from the Natural History Museum">
        <meta property="og:description" content="Visualizing 150000 butterflies from the Natural History Museum - Personal blog about game development, programming and making">
        <meta property="og:image" content="https://marian42.de/article/butterflies/tsne_1280.jpg">
        <meta property="og:url" content="https://marian42.de/article/butterflies/">
        <meta property="og:site_name" content="Marian's Blog"><meta property="og:type" content="website">

        <link rel="icon" type="image/png" href="https://marian42.de/favicon-32x32.png" sizes="32x32">
        <link rel="icon" type="image/png" href="https://marian42.de/favicon-16x16.png" sizes="16x16">

        <link href="https://marian42.de/index.xml" rel="feed" type="application/rss+xml" title="Marian's Blog" />
                
        <link rel="stylesheet" href="/style.css">        
    </head>
    <body>
        <header class="triangle-pattern">
            <div class="container">
                <a href="/" class="logo" alt="Marian's Blog">
                </a>
            </div>
        </header>
        
        <article class="card">
    <a href="/article/butterflies/">
        <h1>Visualizing 150000 butterflies from the Natural History Museum</h1>
    </a>
    <div class="timestamp">December 26, 2019</div>
    <div class="content">
        <p><figure>
    <a href="tsne.jpg">
        <img src="tsne_1280.jpg" alt="">
    </a>
</figure></p>
<p><a href="https://marian42.de/butterflies/">Click here for the interactive visualization.</a></p>
<p>The Natural History Museum in London has a <a href="https://data.nhm.ac.uk/">data portal</a> in which they provide digital records for many of their specimens.
Some of these records have images.
I recently learned how to use machine learning tools such as convolutional neural networks and I wanted to use the NHM data to see what can be done with these tools.
The dataset of butterflies seemed particularly interesting to me because the images are visually interesting, yet they are all similar in that they all contain a butterfly in a canonical pose.</p>
<p>Since I'm only interested in learning the visuals of the butterflies and not the rest of the photographs, such as the labels, I needed to find a way to separate the butterflies from the background.
Here, you can see <a href="https://data.nhm.ac.uk/dataset/56e711e6-c847-4f99-915a-6894bb5c5dea/resource/05ff2255-c38a-40c9-b657-4ccb55ab2feb?view_id=6ba121d1-da26-4ee1-81fa-7da11e68f68e&amp;filters=project%3Apapilionoidea+new+types+digitisation+project">one collection</a> of ~2000 butterflies, which are photographed against a clear background:</p>
<p><figure>
    <a href="dataportal.png">
        <img src="dataportal.png" alt="">
    </a>
</figure></p>
<p>It is quite easy to remove the background automatically based on contrast.
However, besides this collection, there are a lot more images of butterflies available.
They can be found by <a href="https://data.nhm.ac.uk/dataset/56e711e6-c847-4f99-915a-6894bb5c5dea/resource/05ff2255-c38a-40c9-b657-4ccb55ab2feb?q=lepidoptera&amp;field=associatedMediaCount&amp;view_id=6ba121d1-da26-4ee1-81fa-7da11e68f68e&amp;value=&amp;filters=_has_image%3Atrue">searching for &quot;lepidoptera&quot; in the data portal</a>.
This way, I downloaded 30 GB of butterflies.
Most of the 150000 images have noisy backgrounds with varying brightness, such as this one:</p>
<p><figure>
    <a href="background-example.jpg">
        <img src="background-example.jpg" alt="">
    </a>
</figure></p>
<p>To separate the butterflies from the backgrounds, I trained a <a href="https://en.wikipedia.org/wiki/U-Net">U-Net</a> that predicts for each pixel of the image whether it belongs to the butterfly or background.
It is a convolutional neural network that receives an image as the input and produces a new image as the output, in my case a background-foreground mask.</p>
<p>I started by manually creating masks for a few images:</p>
<p><figure>
    <a href="masks.png">
        <img src="masks_1280.png" alt="">
    </a>
</figure></p>
<p>I trained the U-Net and tested it on random images from the dataset.
From those I selected the images where the classification went poorly and manually added masks for them to the training set.
This selection process leads to a ground truth dataset that contains mostly &quot;challenging&quot; items.
I ended up with ~300 masks, however it works reasonably well even with fewer images.
Since the network needs to make a prediction for every single pixel, it is forced to generalize even when trained on a single image.</p>
<p>Using the masks generated by the U-Net, I can remove the background and crop all the images in the dataset:</p>
<p><figure>
    <a href="alpha.jpg">
        <img src="alpha_1280.jpg" alt="">
    </a>
</figure></p>
<p>Next, I created a 128✕128 image with a white background for each butterfly and trained an autoencoder on them.
The autoencoder receives an images as the input and produces a reconstructed image as the output.
Its loss function is the difference between the input and output so that during training, it learns to reduce that difference and creates an accurate reconstruction of the input.
The autoencoder has a bottleneck in the middle which consists of 128 neurons.
This way, it learns to compress each image into a <em>latent vector</em> of 128 numbers.</p>
<p>Here are some examples of images reconstructed with the autoencoder:</p>
<p><figure>
    <a href="reconstruction.jpg">
        <img src="reconstruction.jpg" alt="">
    </a>
</figure></p>
<p>During 6 hours of training, the network didn't converge, meaning that a better quality could be achieved by training longer.
However, for this project I'm mostly interested in the latent space learned by the autoencoder, not the reconstructed images.</p>
<p>I used the encoder of the autoencoder to calculate the latent vectors for all images in the dataset.
To visualize the latent space, I used <a href="https://en.wikipedia.org/wiki/T-distributed_stochastic_neighbor_embedding">t-SNE</a> to transform the latent vectors from 128-dimensional space to a 2D plane.</p>
<p>In this t-SNE plot, each dot corresponds to an image in the dataset.
The t-SNE transformation places the points so that those points appear close to each other that have similar latent vectors, meaning that they appear similar to the autoencoder.</p>
<p><figure>
    <a href="tsne-plot.png">
        <img src="tsne-plot_1280.png" alt="">
    </a>
</figure></p>
<p>Next, I wanted to replace the dots in the plot with images of the corresponding butterflies.
To prevent overlapping of very close points, I iteratively moved them apart.
This was done by defining a &quot;safe&quot; radius and finding all points that have a neighbor within this radius.
Each point is then moved away from its closest neighbor by a small distance:</p>
<p><figure>
    <video autoplay loop muted playsinline>
        <source src="move_points.mp4" type="video/mp4"/>
    </video>
</figure></p>
<p>Here is a part of the resulting image, where I also added some drop shadows:</p>
<p><figure>
    <a href="map-part.jpg">
        <img src="map-part_1280.jpg" alt="">
    </a>
</figure></p>
<p>We can already see that similar butterflies are clustered together.
However, this t-SNE plot is 131000✕131000 pixels big.
That is 17 Gigapixels!
To display it, I'm using <a href="https://leafletjs.com/">Leaflet</a>, a javascript library that can render maps.
The image is split into tiles with a resolution of 256x256 pixels which are loaded dynamically by Leaflet.
I also created tiles for lower zoom levels, so that people can zoom out like on a map.</p>
<p>When the map is zoomed all the way out, the images appear as tiny dots.
For the intermediate zoom levels, I rendered a few &quot;representative&quot; images.
These are selected by applying a <a href="https://en.wikipedia.org/wiki/K-means_clustering">k-means clustering</a> to the t-SNE points.
For each cluster, a representative image is rendered at the cluster center.
The representative image is selected by calculating the average of the cluster in latent space (not t-SNE space) and finding the butterfly with the latent vector that is closest to the average.
I found that when using t-SNE space to determine the representative, an outlier is often selected, which doesn't happen in latent space.</p>
<p><figure>
    <a href="cluster.jpg">
        <img src="cluster_1280.jpg" alt="">
    </a>
</figure></p>
<p>The tileset contains 138000 images, which is ~900 MB.
This is what it looks like to zoom around in the interactive t-SNE plot:</p>
<p><figure>
    <video autoplay loop muted playsinline>
        <source src="zoom.mp4" type="video/mp4"/>
    </video>
</figure></p>
<p><a href="https://marian42.de/butterflies/">Click here for the interactive version of the t-SNE plot.</a></p>
<p>I also added the ability to click on the butterflies to show a popup with the original image, the scientific name and some other data.</p>
<p><figure>
    <a href="popup.png">
        <img src="popup.png" alt="">
    </a>
</figure></p>
<p>These information are provided in the NHM data portal as a CSV file.
I wrote a script that creates a JSON file with the t-SNE positions of the points and the corresponding data.
But this metadata file alone is 50MB in size.
It is not feasible to load it when someone visits the website.
So I split the metadata into smaller chunks using a quadtree, much like the images are split into tiles.
Now the metadata is loaded only for the regions that the user looks at.</p>
<p>Using the data from these CSV files, I can color the dots in the t-SNE plot according to the genus of the butterflies:</p>
<p><figure>
    <a href="genus.png">
        <img src="genus_1280.png" alt="">
    </a>
</figure></p>
<p>We can see that the autoencoder has learned to separate the butterflies by genus, solely based on the visuals, without being provided any information about the genus!
This is an example of unsupervised training of a classifier.</p>
<p>Similarly, it mostly placed the families in adjacent clusters:</p>
<p><figure>
    <a href="families.png">
        <img src="families_1280.png" alt="">
    </a>
</figure></p>
<p>There is an <a href="https://marian42.de/butterflies/?-0.15302,0.12622,13">area in the plot</a> where lots of colors mix.
These are specimens with missing wings.
Since the missing wing is the most striking visual feature, it primarily determines the latent vector that the autoencoder assigns.</p>
<p><figure>
    <a href="missing-wing.jpg">
        <img src="missing-wing.jpg" alt="">
    </a>
</figure></p>
<p>Using the same method for the sex, we can see that most of the records contain no sex information.
But for the <a href="https://marian42.de/butterflies/?-0.40247,-0.76001,12">birdwings</a>, for which this information is available, the autoencoder has learned to separate male from female, again, without being tasked to do so.</p>
<p><figure>
    <a href="male-female.png">
        <img src="male-female_1280.png" alt="">
    </a>
</figure></p>
<p>We can observe a similar result for the <a href="https://marian42.de/butterflies/?-0.23245,0.17975,14">delias</a>.</p>
<p>The <a href="https://github.com/marian42/butterflies">source code for this project is available on Github</a>.
The images of the butterflies are provided by the <a href="https://data.nhm.ac.uk/">Trustees of the Natural History Museum</a> under a <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> license.</p>

    </div>
</article>

        <footer>
            <div class="socials">
                <div class="inner-div">
                    <a href="mailto:mail@marian42.de">
                        Contact
                    </a>
                </div>
                <div>
                    <a href="https://mastodon.gamedev.place/@marian42" rel="me" title="Follow me on Mastodon" class="social-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="-32 0 512 512">                                
                            <path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/>
                        </svg>
                    </a>
                    <a href="https://twitter.com/marian42_" title="Follow me on Twitter" class="social-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 248 204">
                            <path d="M221.95,51.29c0.15,2.17,0.15,4.34,0.15,6.53c0,66.73-50.8,143.69-143.69,143.69v-0.04 C50.97,201.51,24.1,193.65,1,178.83c3.99,0.48,8,0.72,12.02,0.73c22.74,0.02,44.83-7.61,62.72-21.66 c-21.61-0.41-40.56-14.5-47.18-35.07c7.57,1.46,15.37,1.16,22.8-0.87C27.8,117.2,10.85,96.5,10.85,72.46c0-0.22,0-0.43,0-0.64 c7.02,3.91,14.88,6.08,22.92,6.32C11.58,63.31,4.74,33.79,18.14,10.71c25.64,31.55,63.47,50.73,104.08,52.76 c-4.07-17.54,1.49-35.92,14.61-48.25c20.34-19.12,52.33-18.14,71.45,2.19c11.31-2.23,22.15-6.38,32.07-12.26 c-3.77,11.69-11.66,21.62-22.2,27.93c10.01-1.18,19.79-3.86,29-7.95C240.37,35.29,231.83,44.14,221.95,51.29z"/>
                        </svg>
                    </a>
                    <a href="https://github.com/marian42" title="View my code on Github" class="social-icon">
                        <svg viewbox="0 0 98 96" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M48.854 0C21.839 0 0 22 0 49.217c0 21.756 13.993 40.172 33.405 46.69 2.427.49 3.316-1.059 3.316-2.362 0-1.141-.08-5.052-.08-9.127-13.59 2.934-16.42-5.867-16.42-5.867-2.184-5.704-5.42-7.17-5.42-7.17-4.448-3.015.324-3.015.324-3.015 4.934.326 7.523 5.052 7.523 5.052 4.367 7.496 11.404 5.378 14.235 4.074.404-3.178 1.699-5.378 3.074-6.6-10.839-1.141-22.243-5.378-22.243-24.283 0-5.378 1.94-9.778 5.014-13.2-.485-1.222-2.184-6.275.486-13.038 0 0 4.125-1.304 13.426 5.052a46.97 46.97 0 0 1 12.214-1.63c4.125 0 8.33.571 12.213 1.63 9.302-6.356 13.427-5.052 13.427-5.052 2.67 6.763.97 11.816.485 13.038 3.155 3.422 5.015 7.822 5.015 13.2 0 18.905-11.404 23.06-22.324 24.283 1.78 1.548 3.316 4.481 3.316 9.126 0 6.6-.08 11.897-.08 13.526 0 1.304.89 2.853 3.316 2.364 19.412-6.52 33.405-24.935 33.405-46.691C97.707 22 75.788 0 48.854 0z"/>
                        </svg>
                    </a>
                    <a href="/index.xml" title="RSS feed" class="social-icon">
                        <svg viewBox="0 0 8 8" xmlns="http://www.w3.org/2000/svg">
                            <path d="M 0.38705632,0.38705632 V 1.5913525 A 6.021594,6.021594 0 0 1 6.4086474,7.6129437 H 7.6129437 A 7.2259129,7.2259129 0 0 0 0.38705632,0.38705632 Z m 0,2.40864748 V 4 A 3.6129564,3.6129564 0 0 1 4,7.6129437 H 5.2042963 A 4.8172751,4.8172751 0 0 0 0.38705632,2.7957038 Z M 1.3430849,5.7008865 A 0.95602666,0.95602666 0 0 0 0.38705632,6.6569151 0.95602666,0.95602666 0 0 0 1.3430849,7.6129437 0.95602666,0.95602666 0 0 0 2.2991135,6.6569151 0.95602666,0.95602666 0 0 0 1.3430849,5.7008865 Z" />
                        </svg>
                    </a>
                </div>
            </div>
            <div class="decorator triangle-pattern">
            </div>
        </footer>
    </body>
</html>